//Dark walking right
const string EMBED_dark0r = "sans/spr_sans_r_dark_0.png";
const string EMBED_dark1r = "sans/spr_sans_r_dark_1.png";
const string EMBED_dark2r = "sans/spr_sans_r_dark_2.png";
const string EMBED_dark3r = "sans/spr_sans_r_dark_3.png";

//Walking right
const string EMBED_walk0r = "sans/spr_sans_r_0.png";
const string EMBED_walk1r = "sans/spr_sans_r_1.png";
const string EMBED_walk2r = "sans/spr_sans_r_2.png";
const string EMBED_walk3r = "sans/spr_sans_r_3.png";

//Faces
const string EMBED_bface0 = "sans/spr_sans_bface_0.png";
const string EMBED_bface1 = "sans/spr_sans_bface_1.png";
const string EMBED_bface2 = "sans/spr_sans_bface_2.png";
const string EMBED_bface3 = "sans/spr_sans_bface_3.png";
const string EMBED_bface4 = "sans/spr_sans_bface_4.png";
const string EMBED_bface5 = "sans/spr_sans_bface_5.png";
const string EMBED_bface6 = "sans/spr_sans_bface_6.png";
const string EMBED_bface7 = "sans/spr_sans_bface_7.png";
const string EMBED_bface8 = "sans/spr_sans_bface_8.png";
const string EMBED_bface9 = "sans/spr_sans_bface_9.png";
const string EMBED_bface10 = "sans/spr_sans_bface_10.png";
const string EMBED_bface11 = "sans/spr_sans_bface_11.png";
const string EMBED_bface12 = "sans/spr_sans_bface_12.png";
const string EMBED_bface13 = "sans/spr_sans_bface_13.png";
const string EMBED_bface14 = "sans/spr_sans_bface_14.png";

//Font
const string EMBED_text0000 = "sanstext/sansFontsSpritesheet_0000.png";
const string EMBED_text0001 = "sanstext/sansFontsSpritesheet_0001.png";
const string EMBED_text0002 = "sanstext/sansFontsSpritesheet_0002.png";
const string EMBED_text0003 = "sanstext/sansFontsSpritesheet_0003.png";
const string EMBED_text0004 = "sanstext/sansFontsSpritesheet_0004.png";
const string EMBED_text0005 = "sanstext/sansFontsSpritesheet_0005.png";
const string EMBED_text0006 = "sanstext/sansFontsSpritesheet_0006.png";
const string EMBED_text0007 = "sanstext/sansFontsSpritesheet_0007.png";
const string EMBED_text0008 = "sanstext/sansFontsSpritesheet_0008.png";
const string EMBED_text0009 = "sanstext/sansFontsSpritesheet_0009.png";
const string EMBED_text0010 = "sanstext/sansFontsSpritesheet_0010.png";
const string EMBED_text0011 = "sanstext/sansFontsSpritesheet_0011.png";
const string EMBED_text0012 = "sanstext/sansFontsSpritesheet_0012.png";
const string EMBED_text0013 = "sanstext/sansFontsSpritesheet_0013.png";
const string EMBED_text0014 = "sanstext/sansFontsSpritesheet_0014.png";
const string EMBED_text0015 = "sanstext/sansFontsSpritesheet_0015.png";
const string EMBED_text0016 = "sanstext/sansFontsSpritesheet_0016.png";
const string EMBED_text0017 = "sanstext/sansFontsSpritesheet_0017.png";
const string EMBED_text0018 = "sanstext/sansFontsSpritesheet_0018.png";
const string EMBED_text0019 = "sanstext/sansFontsSpritesheet_0019.png";
const string EMBED_text0020 = "sanstext/sansFontsSpritesheet_0020.png";
const string EMBED_text0021 = "sanstext/sansFontsSpritesheet_0021.png";
const string EMBED_text0022 = "sanstext/sansFontsSpritesheet_0022.png";
const string EMBED_text0023 = "sanstext/sansFontsSpritesheet_0023.png";
const string EMBED_text0024 = "sanstext/sansFontsSpritesheet_0024.png";
const string EMBED_text0025 = "sanstext/sansFontsSpritesheet_0025.png";
const string EMBED_text0026 = "sanstext/sansFontsSpritesheet_0026.png";
const string EMBED_text0027 = "sanstext/sansFontsSpritesheet_0027.png";
const string EMBED_text0028 = "sanstext/sansFontsSpritesheet_0028.png";
const string EMBED_text0029 = "sanstext/sansFontsSpritesheet_0029.png";
const string EMBED_text0030 = "sanstext/sansFontsSpritesheet_0030.png";
const string EMBED_text0031 = "sanstext/sansFontsSpritesheet_0031.png";
const string EMBED_text0032 = "sanstext/sansFontsSpritesheet_0032.png";
const string EMBED_text0033 = "sanstext/sansFontsSpritesheet_0033.png";
const string EMBED_text0034 = "sanstext/sansFontsSpritesheet_0034.png";
const string EMBED_text0035 = "sanstext/sansFontsSpritesheet_0035.png";
const string EMBED_text0036 = "sanstext/sansFontsSpritesheet_0036.png";
const string EMBED_text0037 = "sanstext/sansFontsSpritesheet_0037.png";
const string EMBED_text0038 = "sanstext/sansFontsSpritesheet_0038.png";
const string EMBED_text0039 = "sanstext/sansFontsSpritesheet_0039.png";
const string EMBED_text0040 = "sanstext/sansFontsSpritesheet_0040.png";
const string EMBED_text0041 = "sanstext/sansFontsSpritesheet_0041.png";
const string EMBED_text0042 = "sanstext/sansFontsSpritesheet_0042.png";
const string EMBED_text0043 = "sanstext/sansFontsSpritesheet_0043.png";
const string EMBED_text0044 = "sanstext/sansFontsSpritesheet_0044.png";
const string EMBED_text0045 = "sanstext/sansFontsSpritesheet_0045.png";
const string EMBED_text0046 = "sanstext/sansFontsSpritesheet_0046.png";
const string EMBED_text0047 = "sanstext/sansFontsSpritesheet_0047.png";
const string EMBED_text0048 = "sanstext/sansFontsSpritesheet_0048.png";
const string EMBED_text0049 = "sanstext/sansFontsSpritesheet_0049.png";
const string EMBED_text0050 = "sanstext/sansFontsSpritesheet_0050.png";
const string EMBED_text0051 = "sanstext/sansFontsSpritesheet_0051.png";
const string EMBED_text0052 = "sanstext/sansFontsSpritesheet_0052.png";
const string EMBED_text0053 = "sanstext/sansFontsSpritesheet_0053.png";
const string EMBED_text0054 = "sanstext/sansFontsSpritesheet_0054.png";
const string EMBED_text0055 = "sanstext/sansFontsSpritesheet_0055.png";
const string EMBED_text0056 = "sanstext/sansFontsSpritesheet_0056.png";
const string EMBED_text0057 = "sanstext/sansFontsSpritesheet_0057.png";
const string EMBED_text0058 = "sanstext/sansFontsSpritesheet_0058.png";
const string EMBED_text0059 = "sanstext/sansFontsSpritesheet_0059.png";
const string EMBED_text0060 = "sanstext/sansFontsSpritesheet_0060.png";
const string EMBED_text0061 = "sanstext/sansFontsSpritesheet_0061.png";
const string EMBED_text0062 = "sanstext/sansFontsSpritesheet_0062.png";
const string EMBED_text0063 = "sanstext/sansFontsSpritesheet_0063.png";
const string EMBED_text0064 = "sanstext/sansFontsSpritesheet_0064.png";
const string EMBED_text0065 = "sanstext/sansFontsSpritesheet_0065.png";
const string EMBED_text0066 = "sanstext/sansFontsSpritesheet_0066.png";
const string EMBED_text0067 = "sanstext/sansFontsSpritesheet_0067.png";
const string EMBED_text0068 = "sanstext/sansFontsSpritesheet_0068.png";
const string EMBED_text0069 = "sanstext/sansFontsSpritesheet_0069.png";
const string EMBED_text0070 = "sanstext/sansFontsSpritesheet_0070.png";
const string EMBED_text0071 = "sanstext/sansFontsSpritesheet_0071.png";
const string EMBED_text0072 = "sanstext/sansFontsSpritesheet_0072.png";
const string EMBED_text0073 = "sanstext/sansFontsSpritesheet_0073.png";
const string EMBED_text0074 = "sanstext/sansFontsSpritesheet_0074.png";
const string EMBED_text0075 = "sanstext/sansFontsSpritesheet_0075.png";
const string EMBED_text0076 = "sanstext/sansFontsSpritesheet_0076.png";
const string EMBED_text0077 = "sanstext/sansFontsSpritesheet_0077.png";
const string EMBED_text0078 = "sanstext/sansFontsSpritesheet_0078.png";
const string EMBED_text0079 = "sanstext/sansFontsSpritesheet_0079.png";
const string EMBED_text0080 = "sanstext/sansFontsSpritesheet_0080.png";
const string EMBED_text0081 = "sanstext/sansFontsSpritesheet_0081.png";
const string EMBED_text0082 = "sanstext/sansFontsSpritesheet_0082.png";
const string EMBED_text0083 = "sanstext/sansFontsSpritesheet_0083.png";
const string EMBED_text0084 = "sanstext/sansFontsSpritesheet_0084.png";
const string EMBED_text0085 = "sanstext/sansFontsSpritesheet_0085.png";
const string EMBED_text0086 = "sanstext/sansFontsSpritesheet_0086.png";
const string EMBED_text0087 = "sanstext/sansFontsSpritesheet_0087.png";
const string EMBED_text0088 = "sanstext/sansFontsSpritesheet_0088.png";
const string EMBED_text0089 = "sanstext/sansFontsSpritesheet_0089.png";
const string EMBED_text0090 = "sanstext/sansFontsSpritesheet_0090.png";
const string EMBED_text0091 = "sanstext/sansFontsSpritesheet_0091.png";
const string EMBED_text0092 = "sanstext/sansFontsSpritesheet_0092.png";
const string EMBED_text0093 = "sanstext/sansFontsSpritesheet_0093.png";
const string EMBED_text0094 = "sanstext/sansFontsSpritesheet_0094.png";

//Sound Effects
const string EMBED_sound1 = "undertale_sounds/000029e6.ogg"; 

class script {
  scene@ g;
  int frame_count;
  int draw_frame_count;

  sprites@ spr;
  [hidden] float Y1, Y2;
  [position,mode:world,layer:19,y:Y1] float X1;
  [position,mode:world,layer:19,y:Y1] float X2;
  sansSprite@ sansAnimator;
  array<string>sansWalkR(4);
  array<string>sansFace(15);
  array<string>fontSprites(97);

  array<array<string>>textboxText;

  //Set to true if textbox is currently showing
  bool isTalking;
  bool closeTextbox;
  script() {
    array<string>sansDarkWalkR = {"dark0r","dark1r","dark2r","dark3r"};
    array<string>sansWalkR = {"walk0r","walk1r","walk2r","walk3r"};
    array<string>sansFace = {"bface0","bface1","bface2","bface3","bface4",
                            "bface5","bface6","bface7","bface8","bface9",
                            "bface10","bface11","bface12","bface13","bface14"};
    array<string>fontSprites = {"text0000","text0001","text0002","text0003","text0004","text0005","text0006","text0007","text0008","text0009","text0010",
                         "text0011","text0012","text0013","text0014","text0015","text0016","text0017","text0018","text0019",
                         "text0020","text0021","text0022","text0023","text0024","text0025","text0026","text0027","text0028",
                         "text0029","text0030","text0031","text0032","text0033","text0034","text0035","text0036","text0037",
                         "text0038","text0039","text0040","text0041","text0042","text0043","text0044","text0045","text0046",
                         "text0047","text0048","text0049","text0050","text0051","text0052","text0053","text0054","text0055",
                         "text0056","text0057","text0058","text0059","text0060","text0061","text0062","text0063","text0064",
                         "text0065","text0066","text0067","text0068","text0069","text0070","text0071","text0072","text0073",
                         "text0074","text0075","text0076","text0077","text0078","text0079","text0080","text0081","text0082",
                         "text0083","text0084","text0085","text0086","text0087","text0088","text0089","text0090","text0091",
                         "text0092","text0093","text0094"};
    
    dictionary sansFont = {
        {'Q', fontSprites[0]},
        {'W', fontSprites[1]},
        {'@', fontSprites[2]},
        {'%', fontSprites[3]},
        {'_', fontSprites[4]},
        {'O', fontSprites[5]},
        {'M', fontSprites[6]},
        {'$', fontSprites[7]},
        {'&', fontSprites[8]},
        {'X', fontSprites[9]},
        {'N', fontSprites[10]},
        {'V', fontSprites[11]},
        {'G', fontSprites[12]},
        {'y', fontSprites[13]},
        {'J', fontSprites[14]},
        {'U', fontSprites[15]},
        {'Z', fontSprites[16]},
        {'Y', fontSprites[17]},
        {'H', fontSprites[18]},
        {'S', fontSprites[19]},
        {'C', fontSprites[20]},
        {'T', fontSprites[21]},
        {'m', fontSprites[22]},
        {'w', fontSprites[23]},
        {'A', fontSprites[24]},
        {'g', fontSprites[25]},
        {'q', fontSprites[26]},
        {'p', fontSprites[27]},
        {'?', fontSprites[28]},
        {'E', fontSprites[29]},
        {'x', fontSprites[30]},
        {'B', fontSprites[31]},
        {'4', fontSprites[32]},
        {'7', fontSprites[33]},
        {'K', fontSprites[34]},
        {'d', fontSprites[35]},
        {'2', fontSprites[36]},
        {'D', fontSprites[37]},
        {'f', fontSprites[38]},
        {'/', fontSprites[39]},
        {'\\', fontSprites[40]},
        {'{', fontSprites[41]},
        {'j', fontSprites[42]},
        {'}', fontSprites[43]},
        {'r', fontSprites[44]},
        {'R', fontSprites[45]},
        {'L', fontSprites[46]},
        {'n', fontSprites[47]},
        {'u', fontSprites[48]},
        {'z', fontSprites[49]},
        {'t', fontSprites[50]},
        {'8', fontSprites[51]},
        {'1', fontSprites[52]},
        {'3', fontSprites[53]},
        {'6', fontSprites[54]},
        {'e', fontSprites[55]},
        {'o', fontSprites[56]},
        {'a', fontSprites[57]},
        {'c', fontSprites[58]},
        {'5', fontSprites[59]},
        {'b', fontSprites[60]},
        {'h', fontSprites[61]},
        {'F', fontSprites[62]},
        {'v', fontSprites[63]},
        {'0', fontSprites[64]},
        {'k', fontSprites[65]},
        {'I', fontSprites[66]},
        {'9', fontSprites[67]},
        {'+', fontSprites[68]},
        {'~', fontSprites[69]},
        {')', fontSprites[70]},
        {'[', fontSprites[71]},
        {']', fontSprites[72]},
        {'(', fontSprites[73]},
        {'P', fontSprites[74]},
        {'s', fontSprites[75]},
        {'=', fontSprites[76]},
        {'*', fontSprites[77]},
        {'-', fontSprites[78]},
        {'<', fontSprites[79]},
        {'>', fontSprites[80]},
        {';', fontSprites[81]},
        {'\"', fontSprites[82]},
        {'^', fontSprites[83]},
        {'|', fontSprites[84]},
        {',', fontSprites[85]},
        {'!', fontSprites[86]},
        {'l', fontSprites[87]},
        {'i', fontSprites[88]},
        {'.', fontSprites[89]},
        {':', fontSprites[90]},
        {'`', fontSprites[91]},
        {'\'', fontSprites[92]},
        {'#', fontSprites[93]},
        {' ', fontSprites[94]}};

    
    @g = get_scene();
    frame_count = 0;
    draw_frame_count = 0;
    @spr = create_sprites();
    @sansAnimator = sansSprite(sansDarkWalkR, sansFace, sansFont, spr);
    closeTextbox = false;
  }

  void build_sprites(message@ msg) {
    //Build walking right in the dark sprites
    msg.set_string("dark0r","dark0r");
    msg.set_string("dark1r","dark1r");
    msg.set_string("dark2r","dark2r");
    msg.set_string("dark3r","dark3r");

    //Build walking right sprites
    msg.set_string("walk0r","walk0r");
    msg.set_string("walk1r","walk1r");
    msg.set_string("walk2r","walk2r");
    msg.set_string("walk3r","walk3r");

    //Build face sprites
    msg.set_string("bface0","bface0");
    msg.set_string("bface1","bface1");
    msg.set_string("bface2","bface2");
    msg.set_string("bface3","bface3");
    msg.set_string("bface4","bface4");
    msg.set_string("bface5","bface5");
    msg.set_string("bface6","bface6");
    msg.set_string("bface7","bface7");
    msg.set_string("bface8","bface8");
    msg.set_string("bface9","bface9");
    msg.set_string("bface10","bface10");
    msg.set_string("bface11","bface11");
    msg.set_string("bface12","bface12");
    msg.set_string("bface13","bface13");
    msg.set_string("bface14","bface14");

    //Build font sprites
    msg.set_string("text0000","text0000");
    msg.set_string("text0001","text0001");
    msg.set_string("text0002","text0002");
    msg.set_string("text0003","text0003");
    msg.set_string("text0004","text0004");
    msg.set_string("text0005","text0005");
    msg.set_string("text0006","text0006");
    msg.set_string("text0007","text0007");
    msg.set_string("text0008","text0008");
    msg.set_string("text0009","text0009");
    msg.set_string("text0010","text0010");
    msg.set_string("text0011","text0011");
    msg.set_string("text0012","text0012");
    msg.set_string("text0013","text0013");
    msg.set_string("text0014","text0014");
    msg.set_string("text0015","text0015");
    msg.set_string("text0016","text0016");
    msg.set_string("text0017","text0017");
    msg.set_string("text0018","text0018");
    msg.set_string("text0019","text0019");
    msg.set_string("text0020","text0020");
    msg.set_string("text0021","text0021");
    msg.set_string("text0022","text0022");
    msg.set_string("text0023","text0023");
    msg.set_string("text0024","text0024");
    msg.set_string("text0025","text0025");
    msg.set_string("text0026","text0026");
    msg.set_string("text0027","text0027");
    msg.set_string("text0028","text0028");
    msg.set_string("text0029","text0029");
    msg.set_string("text0030","text0030");
    msg.set_string("text0031","text0031");
    msg.set_string("text0032","text0032");
    msg.set_string("text0033","text0033");
    msg.set_string("text0034","text0034");
    msg.set_string("text0035","text0035");
    msg.set_string("text0036","text0036");
    msg.set_string("text0037","text0037");
    msg.set_string("text0038","text0038");
    msg.set_string("text0039","text0039");
    msg.set_string("text0040","text0040");
    msg.set_string("text0041","text0041");
    msg.set_string("text0042","text0042");
    msg.set_string("text0043","text0043");
    msg.set_string("text0044","text0044");
    msg.set_string("text0045","text0045");
    msg.set_string("text0046","text0046");
    msg.set_string("text0047","text0047");
    msg.set_string("text0048","text0048");
    msg.set_string("text0049","text0049");
    msg.set_string("text0050","text0050");
    msg.set_string("text0051","text0051");
    msg.set_string("text0052","text0052");
    msg.set_string("text0053","text0053");
    msg.set_string("text0054","text0054");
    msg.set_string("text0055","text0055");
    msg.set_string("text0056","text0056");
    msg.set_string("text0057","text0057");
    msg.set_string("text0058","text0058");
    msg.set_string("text0059","text0059");
    msg.set_string("text0060","text0060");
    msg.set_string("text0061","text0061");
    msg.set_string("text0062","text0062");
    msg.set_string("text0063","text0063");
    msg.set_string("text0064","text0064");
    msg.set_string("text0065","text0065");
    msg.set_string("text0066","text0066");
    msg.set_string("text0067","text0067");
    msg.set_string("text0068","text0068");
    msg.set_string("text0069","text0069");
    msg.set_string("text0070","text0070");
    msg.set_string("text0071","text0071");
    msg.set_string("text0072","text0072");
    msg.set_string("text0073","text0073");
    msg.set_string("text0074","text0074");
    msg.set_string("text0075","text0075");
    msg.set_string("text0076","text0076");
    msg.set_string("text0077","text0077");
    msg.set_string("text0078","text0078");
    msg.set_string("text0079","text0079");
    msg.set_string("text0080","text0080");
    msg.set_string("text0081","text0081");
    msg.set_string("text0082","text0082");
    msg.set_string("text0083","text0083");
    msg.set_string("text0084","text0084");
    msg.set_string("text0085","text0085");
    msg.set_string("text0086","text0086");
    msg.set_string("text0087","text0087");
    msg.set_string("text0088","text0088");
    msg.set_string("text0089","text0089");
    msg.set_string("text0090","text0090");
    msg.set_string("text0091","text0091");
    msg.set_string("text0092","text0092");
    msg.set_string("text0093","text0093");
    msg.set_string("text0094","text0094");
    msg.set_string("text0095","text0095");
    msg.set_string("text0096","text0096");
    msg.set_string("text0097","text0097");
    msg.set_string("text0098","text0098");
    msg.set_string("text0099","text0099");
    msg.set_string("text0100","text0100");
    msg.set_string("text0101","text0101");
  }

  void build_sounds(message@ msg) {
    msg.set_string(EMBED_sound1.split(".")[0], "sound1");
  }

  void on_level_start() {
    spr.add_sprite_set("script");
    
  }

  void step(int) { 
      dustman@ dm = controller_entity(0).as_dustman();

      // Advance text when light attack is pressed
      if(dm.light_intent() == 10) {
        closeTextbox = sansAnimator.advanceText();
      }
      frame_count++;
  }

  void draw(float subframe) {
    draw_frame_count++;
    sansAnimator.walkRightDark(draw_frame_count, spr, X1, Y1, X2, Y2);

    if(!closeTextbox) {
        array<string> text = {"this game looks cool...","what?","what else did you think i would say?"};
        array<string> textFaces = {"bface0", "bface1", "bface3"};
        sansAnimator.say(g, spr, text, textFaces, draw_frame_count, frame_count);
    }
  }
}

class sansSprite {
    //Sprites
    array<string> darkWalkingR; // all walking right sprites blacked out
    array<string> face; // all face sprites
    dictionary font; // the entire font sprite list
    array<string> charSpriteList; // list of sprites in order that we want to draw
 
    float X1, Y1, X2, Y2; // Sprite Positions.  These are used to move the sprite around.  
    int curFrame; // Current animation frame
    uint colour = 0xFFFFFFFF;   
    int walkSpeed; // Speed we want the sprite to animate.  Most animations are walking.

    float charScale; // How much we want to scale the characters in the textbox
    float startTextX;
    float startTextY;

    //Textbox variables
    array<string> text; // what the current text we want to say is
    uint curTextIndex; // Where we are in the array of strings passed to the say function
    bool isTalking; // bool that tells us if the textbox is displayed
    int curCharacter; // Want to show characters one at a time like in undertale.  Keeps track of what character we currently are up to
    int textSpeed; // speed we want each character to show up in a textbox. This would be measured in #drawframes per character
    int pauseTime;  // after things like '...' ',' and '.' we want to take a pause.  Different characters call for different pauses.
    int lastPhysFrame;
    audio@ lastSound; // keep track of the last played audio handle to stop it when we want to start another
    bool skipSound;

    sansSprite(array<string>darkWalkingSprites, array<string>faceSprites, dictionary fontSprites, sprites@ spr) {
        walkSpeed = 50;
        darkWalkingR = darkWalkingSprites;
        face = faceSprites;
        font = fontSprites;

        //Start position for the sprite
        X1 = 0; Y1 = 0;

        //End position for the sprite
        X2 = 0; Y2 = 0;

        curFrame = 0;
        charScale = 1;
        startTextY = 250;
        startTextX = -355;
        curTextIndex = 0;
        isTalking = false;
        curCharacter = -1;
        textSpeed = 2; 
        pauseTime = -1;
        lastPhysFrame = -1;
        @lastSound = null;
        skipSound = false;
    }

    void walkRightDark(int frame, sprites@ spr, float startX, float startY, float endX, float endY) {

        if(X1 == 0 && Y1 == 0 && X2 == 0 && Y2 == 0) {
            X1 = startX;
            X2 = endX;
            Y1 = startY;
            Y2 = endY;
        }

        spr.draw_world(19, 19, darkWalkingR[curFrame], 0, 1, X1, (((curFrame+1)%2)*4)+startY,
                       0, .8, .8, colour);

        if(X1 != endX) {
            X1++;
        }
        if(frame%walkSpeed == 0) {
            curFrame = curFrame + 1 >= darkWalkingR.size() ? 0 : curFrame+1;
        }
    }

    bool say(scene@ g, sprites@ spr, array<string> txt, array<string> textFaces, int frame, int physFrames) {
        /* void draw_hud(int layer, int sub_layer, string spriteName,
                         uint32 frame, uint32 palette, float x, float y, float rotation,
                         float scale_x, float scale_y, uint32 colour);*/

        // We are currently displaying the textbox
        isTalking = true;
        text = txt;

        // init cur character
        if(curCharacter == -1) {
            curCharacter = 0;
        }

        // Draw the textbox
        g.draw_rectangle_hud(19, 17, -650, 200, 650, 425, 0, 0xFFFFFFFF);
        g.draw_rectangle_hud(19, 18, -640, 210, 640, 415,0, 0xFF000000);

        //TODO: be sure to check if the size of textFaces and txt is the same
        //San's face
        spr.draw_hud(19, 19, textFaces[curTextIndex], 1, 1, -600, 260, 0, .75, .75, colour);

        float AsteriskStart = 250;

        //Asterisk 
        spr.draw_hud(20, 20, string(font['*']), 1, 1, -415, AsteriskStart, 0, charScale, charScale, colour); 
        writeText(g, spr, string(txt[curTextIndex]), frame, physFrames);
        return isTalking;    
    }

    void writeText(scene@ g, sprites@ spr, string txt, int frame, int physFrames) {
        //Replace with where you want to start the line
        float curX = startTextX;
        float curY = startTextY;
        
        //Go through all the characters in txt and print them to the screen
        for(int i = 0; i <= curCharacter; i++) {
            //if we find a space, make one
            if(txt.substr(i,1) == " ") {
                curX += getCharWidth(spr, "o");
            } else if(txt.substr(i,1) == "\n") { 
                //return to start of line
                curX = startTextX;
                //move down to the next line.  Use the tallest character to space lines
                curY += getCharHeight(spr, "|");
            } else {
                //no special characters, print the next character
                spr.draw_hud(20, 20, string(font[txt.substr(i,1)]), 1, 1, curX, curY, 0, charScale, charScale, colour);
                curX += getCharWidth(spr, txt.substr(i,1));
            }    
        }


        // Always draw the textbox and current characters, but dont increment the current char ever draw frame as it isnt stable
        if(physFrames == lastPhysFrame) {
            return;
        }

        lastPhysFrame = physFrames;


        // Keep incrementing what character to draw so we draw them one at a time.
        if((curCharacter < txt.size()) && (lastPhysFrame%textSpeed == 0)) {
            
            string curChar = txt.substr(curCharacter,1);

            if((curChar == "." || curChar == "?") && pauseTime == -1) {
                pauseTime = 4;
            } else if(curChar == "," && pauseTime == -1) {
                pauseTime = 4;
            } else if(curChar == "\n" && pauseTime == -1) {
                //no pause
            } else if(pauseTime != -1) {
                pauseTime = pauseTime - 1 == 0 ? -1 : pauseTime - 1;

                if(pauseTime == -1) {
                    curCharacter += curCharacter <= txt.size() ? 1:0;
                    return;
                }
            }
            
            if(pauseTime == -1) { // We want to play a sound for every character except '.' '\n' and ',' while we are not pausing

                if(!skipSound) {
                    @lastSound = g.play_script_stream(EMBED_sound1.split(".")[0], 3, 0, 0, false, 1 );
                }
                skipSound = !skipSound;
                curCharacter += curCharacter <= txt.size() ? 1:0;
            }      
        }
    }

    //Returns bool telling you if textbox is finished
    bool advanceText() {
        // do nothing if we are not talking
        if(!isTalking) {
            return true;
        }

        // if textbox has not shown all characters, show them all instead of advancing text
        if(curCharacter < string(text[curTextIndex]).size()) {
            curCharacter = string(text[curTextIndex]).size()-1;
        } else {
            // if we are on the last character and at the end of the textboxes, close the textbox
            if(curTextIndex == text.size()-1) {
                closeTextbox();
                return true;
            } else { //advance text
                curCharacter = -1;
                curTextIndex++;
            }
        }

        return false;
    }

    void closeTextbox() {
        isTalking = false;
        pauseTime = 0;
        curTextIndex = 0;
    }

    float getCharWidth(sprites@ spr, string char) {
        if(char.size() != 1) {
            return 0;
        } else {
            return spr.get_sprite_rect(string(font[char]), 0).get_width() * charScale;
        }
    }

    float getCharHeight(sprites@ spr, string char) {
        if(char.size() != 1) {
            return 0;
        } else {
            return spr.get_sprite_rect(string(font[char]), 0).get_height() * charScale;
        }
    }
}